//
//  TerminalPoolWrapper.swift
//  ETerm
//
//  æ–°æ¶æ„ï¼šå¤šç»ˆç«¯ç®¡ç† + ç»Ÿä¸€æ¸²æŸ“
//
//  ä½¿ç”¨æ–¹å¼ï¼š
//    pool.beginFrame()
//    for panel in visiblePanels {
//        pool.renderTerminal(id, x: panel.x, y: panel.y)
//    }
//    pool.endFrame()
//

import Foundation
import AppKit

/// ç»ˆç«¯äº‹ä»¶ç±»å‹
enum TerminalPoolSwiftEventType: UInt32 {
    case wakeup = 0
    case render = 1
    case cursorBlink = 2
    case bell = 3
    case titleChanged = 4
    case damaged = 5
}

/// ç»ˆç«¯å•è¯è¾¹ç•Œä¿¡æ¯ï¼ˆç½‘æ ¼åæ ‡ï¼‰
///
/// ä¸ WordBoundary çš„åŒºåˆ«ï¼š
/// - WordBoundary: NaturalLanguage åˆ†è¯ç»“æœï¼ˆå­—ç¬¦ä¸²ç´¢å¼•ï¼‰
/// - TerminalWordBoundary: ç»ˆç«¯ç½‘æ ¼å•è¯ï¼ˆè¡Œåˆ—åæ ‡ï¼‰
struct TerminalWordBoundary {
    /// å•è¯èµ·å§‹åˆ—ï¼ˆå±å¹•åæ ‡ï¼‰
    let startCol: Int
    /// å•è¯ç»“æŸåˆ—ï¼ˆå±å¹•åæ ‡ï¼ŒåŒ…å«ï¼‰
    let endCol: Int
    /// ç»å¯¹è¡Œå·
    let absoluteRow: Int64
    /// å•è¯æ–‡æœ¬
    let text: String
}

/// ç»ˆç«¯æ±  Wrapperï¼ˆæ–°æ¶æ„ï¼‰
///
/// èŒè´£åˆ†ç¦»ï¼š
/// - TerminalPool ç®¡ç†å¤šä¸ªç»ˆç«¯å®ä¾‹ï¼ˆçŠ¶æ€ + PTYï¼‰
/// - æ¸²æŸ“ä½ç½®ç”±è°ƒç”¨æ–¹æŒ‡å®šï¼ˆSwift æ§åˆ¶å¸ƒå±€ï¼‰
/// - ç»Ÿä¸€æäº¤ï¼šbeginFrame â†’ renderTerminal Ã— N â†’ endFrame
class TerminalPoolWrapper: TerminalPoolProtocol {

    // MARK: - Properties

    private var handle: TerminalPoolHandle?

    /// æš´éœ² handle ç”¨äº RenderScheduler ç»‘å®š
    var poolHandle: TerminalPoolHandle? { handle }

    /// æ¸²æŸ“å›è°ƒ
    private var renderCallback: (() -> Void)?

    /// ç»ˆç«¯å…³é—­å›è°ƒ
    var onTerminalClose: ((Int) -> Void)?

    /// Bell å›è°ƒ
    var onBell: ((Int) -> Void)?

    // MARK: - Initialization

    /// åˆ›å»ºç»ˆç«¯æ± 
    ///
    /// - Parameters:
    ///   - windowHandle: NSView çš„åŸå§‹æŒ‡é’ˆ
    ///   - displayHandle: NSWindow çš„åŸå§‹æŒ‡é’ˆ
    ///   - width: çª—å£å®½åº¦ï¼ˆé€»è¾‘åƒç´ ï¼‰
    ///   - height: çª—å£é«˜åº¦ï¼ˆé€»è¾‘åƒç´ ï¼‰
    ///   - scale: DPI ç¼©æ”¾å› å­
    ///   - fontSize: å­—ä½“å¤§å°
    init?(windowHandle: UnsafeMutableRawPointer,
          displayHandle: UnsafeMutableRawPointer,
          width: Float,
          height: Float,
          scale: Float,
          fontSize: Float = 14.0) {

        let config = TerminalPoolConfig(
            cols: 80,
            rows: 24,
            font_size: fontSize,
            line_height: 1.0,  // è¡Œé«˜å› å­ï¼š1.0 = 100%ï¼ˆè°ƒè¯•ç”¨ï¼‰
            scale: scale,
            window_handle: windowHandle,
            display_handle: displayHandle,
            window_width: width,
            window_height: height,
            history_size: 10000
        )

        handle = terminal_pool_create(config)

        guard handle != nil else {
            print("âŒ [TerminalPoolWrapper] Failed to create pool")
            return nil
        }

        print("âœ… [TerminalPoolWrapper] Pool created")
        setupEventCallback()
    }

    deinit {
        if let handle = handle {
            terminal_pool_destroy(handle)
            print("ğŸ—‘ï¸ [TerminalPoolWrapper] Pool destroyed")
        }
    }

    // MARK: - Event Callback

    private func setupEventCallback() {
        guard let handle = handle else { return }

        let contextPtr = Unmanaged.passUnretained(self).toOpaque()

        terminal_pool_set_event_callback(
            handle,
            { (context, event) in
                guard let context = context else { return }
                let wrapper = Unmanaged<TerminalPoolWrapper>.fromOpaque(context).takeUnretainedValue()
                wrapper.handleEvent(event)
            },
            contextPtr
        )
    }

    private func handleEvent(_ event: TerminalPoolEvent) {
        let terminalId = Int(event.data)

        switch event.event_type {
        case TerminalEventType_Wakeup, TerminalEventType_Render:
            DispatchQueue.main.async { [weak self] in
                self?.renderCallback?()
            }

        case TerminalEventType_Bell:
            DispatchQueue.main.async { [weak self] in
                self?.onBell?(terminalId)
            }

        case TerminalEventType_Damaged:
            DispatchQueue.main.async { [weak self] in
                self?.renderCallback?()
            }

        default:
            break
        }
    }

    // MARK: - TerminalPoolProtocol Implementation

    func createTerminal(cols: UInt16, rows: UInt16, shell: String) -> Int {
        guard let handle = handle else { return -1 }
        let id = terminal_pool_create_terminal(handle, cols, rows)
        print("ğŸ†• [TerminalPoolWrapper] Created terminal \(id)")
        return Int(id)
    }

    func createTerminalWithCwd(cols: UInt16, rows: UInt16, shell: String, cwd: String) -> Int {
        guard let handle = handle else { return -1 }
        print("ğŸ†• [TerminalPoolWrapper] Creating terminal with CWD: \(cwd)")
        let id = terminal_pool_create_terminal_with_cwd(handle, cols, rows, cwd)
        print("ğŸ†• [TerminalPoolWrapper] Created terminal \(id) with CWD")
        return Int(id)
    }

    /// è·å–ç»ˆç«¯çš„å½“å‰å·¥ä½œç›®å½•
    func getCwd(terminalId: Int) -> String? {
        guard let handle = handle else { return nil }

        let cStr = terminal_pool_get_cwd(handle, terminalId)
        guard let cStr = cStr else { return nil }

        let result = String(cString: cStr)
        rio_free_string(cStr)
        return result
    }

    @discardableResult
    func closeTerminal(_ terminalId: Int) -> Bool {
        guard let handle = handle else { return false }
        let result = terminal_pool_close_terminal(handle, terminalId)
        print("ğŸ—‘ï¸ [TerminalPoolWrapper] Closed terminal \(terminalId): \(result)")
        return result
    }

    func getTerminalCount() -> Int {
        guard let handle = handle else { return 0 }
        return Int(terminal_pool_terminal_count(handle))
    }

    @discardableResult
    func writeInput(terminalId: Int, data: String) -> Bool {
        guard let handle = handle,
              let dataBytes = data.data(using: .utf8) else { return false }
        return dataBytes.withUnsafeBytes { ptr in
            guard let baseAddress = ptr.baseAddress else { return false }
            return terminal_pool_input(handle, terminalId, baseAddress.assumingMemoryBound(to: UInt8.self), dataBytes.count)
        }
    }

    @discardableResult
    func readAllOutputs() -> Bool {
        // äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œä¸éœ€è¦è½®è¯¢
        return false
    }

    @discardableResult
    func scroll(terminalId: Int, deltaLines: Int32) -> Bool {
        guard let handle = handle else { return false }
        return terminal_pool_scroll(handle, terminalId, deltaLines)
    }

    @discardableResult
    func resize(terminalId: Int, cols: UInt16, rows: UInt16) -> Bool {
        guard let handle = handle else { return false }
        // ä½¿ç”¨é»˜è®¤çš„åƒç´ å°ºå¯¸ï¼ˆä¼šåœ¨ Rust ä¾§è®¡ç®—ï¼‰
        return terminal_pool_resize_terminal(handle, terminalId, cols, rows, 0, 0)
    }

    func setRenderCallback(_ callback: @escaping () -> Void) {
        renderCallback = callback
    }

    @discardableResult
    func render(terminalId: Int, x: Float, y: Float, width: Float, height: Float, cols: UInt16, rows: UInt16) -> Bool {
        guard let handle = handle else { return false }
        // æ–°æ¶æ„ï¼šç›´æ¥è°ƒç”¨ renderTerminalï¼ˆä¼ é€’ width/height ç”¨äºè‡ªåŠ¨ resizeï¼‰
        return terminal_pool_render_terminal(handle, terminalId, x, y, width, height)
    }

    func flush() {
        // æ–°æ¶æ„ä¸­ flush åœ¨ endFrame ä¸­å®Œæˆ
        endFrame()
    }

    func clear() {
        // æ–°æ¶æ„ä¸­ clear åœ¨ beginFrame ä¸­å®Œæˆ
        beginFrame()
    }

    func getCursorPosition(terminalId: Int) -> CursorPosition? {
        guard let handle = handle else { return nil }

        let result = terminal_pool_get_cursor(handle, terminalId)
        guard result.valid else { return nil }

        return CursorPosition(col: result.col, row: result.row)
    }

    /// è·å–æŒ‡å®šä½ç½®çš„å•è¯è¾¹ç•Œï¼ˆç»ˆç«¯ç½‘æ ¼ï¼‰
    ///
    /// - Parameters:
    ///   - terminalId: ç»ˆç«¯ ID
    ///   - screenRow: å±å¹•è¡Œå·ï¼ˆç›¸å¯¹äºå¯è§åŒºåŸŸï¼Œä» 0 å¼€å§‹ï¼‰
    ///   - screenCol: å±å¹•åˆ—å·ï¼ˆä» 0 å¼€å§‹ï¼‰
    /// - Returns: å•è¯è¾¹ç•Œä¿¡æ¯ï¼Œå¤±è´¥è¿”å› nil
    func getWordAt(terminalId: Int, screenRow: Int, screenCol: Int) -> TerminalWordBoundary? {
        guard let handle = handle else { return nil }
        guard screenRow >= 0 && screenCol >= 0 else { return nil }

        let result = terminal_pool_get_word_at(handle, Int32(terminalId), Int32(screenRow), Int32(screenCol))
        guard result.valid else { return nil }

        // è½¬æ¢ C å­—ç¬¦ä¸²ä¸º Swift String
        guard let textPtr = result.text_ptr else { return nil }
        let text = String(cString: textPtr)

        // é‡Šæ”¾ Rust åˆ†é…çš„å†…å­˜
        terminal_pool_free_word_boundary(result)

        return TerminalWordBoundary(
            startCol: Int(result.start_col),
            endCol: Int(result.end_col),
            absoluteRow: result.absolute_row,
            text: text
        )
    }

    @discardableResult
    func clearSelection(terminalId: Int) -> Bool {
        guard let handle = handle else { return false }
        return terminal_pool_clear_selection(handle, terminalId)
    }

    /// å±å¹•åæ ‡è½¬ç»å¯¹åæ ‡
    func screenToAbsolute(terminalId: Int, screenRow: Int, screenCol: Int) -> (absoluteRow: Int64, col: Int)? {
        guard let handle = handle else { return nil }
        let result = terminal_pool_screen_to_absolute(handle, terminalId, screenRow, screenCol)
        if result.success {
            return (result.absolute_row, Int(result.col))
        }
        return nil
    }

    /// è®¾ç½®é€‰åŒº
    @discardableResult
    func setSelection(terminalId: Int, startAbsoluteRow: Int64, startCol: Int, endAbsoluteRow: Int64, endCol: Int) -> Bool {
        guard let handle = handle else { return false }
        return terminal_pool_set_selection(handle, terminalId, startAbsoluteRow, startCol, endAbsoluteRow, endCol)
    }

    func getInputRow(terminalId: Int) -> UInt16? {
        // TODO: éœ€è¦åœ¨ Rust ä¾§æ·»åŠ æ­¤ API
        return nil
    }

    func changeFontSize(operation: SugarloafWrapper.FontSizeOperation) {
        guard let handle = handle else { return }
        _ = terminal_pool_change_font_size(handle, operation.rawValue)
    }

    /// è·å–å­—ä½“åº¦é‡ï¼ˆç‰©ç†åƒç´ ï¼‰
    ///
    /// è¿”å›ä¸æ¸²æŸ“ä¸€è‡´çš„å­—ä½“åº¦é‡
    func getFontMetrics() -> SugarloafFontMetrics? {
        guard let handle = handle else { return nil }
        var metrics = SugarloafFontMetrics()
        if terminal_pool_get_font_metrics(handle, &metrics) {
            return metrics
        }
        return nil
    }

    // MARK: - New Architecture Methods

    /// è°ƒæ•´ç»ˆç«¯å¤§å°ï¼ˆåŒ…å«åƒç´ å°ºå¯¸ï¼‰
    func resizeTerminal(_ id: Int, cols: UInt16, rows: UInt16, width: Float, height: Float) -> Bool {
        guard let handle = handle else { return false }
        return terminal_pool_resize_terminal(handle, id, cols, rows, width, height)
    }

    /// å¼€å§‹æ–°çš„ä¸€å¸§
    func beginFrame() {
        guard let handle = handle else { return }
        terminal_pool_begin_frame(handle)
    }

    /// æ¸²æŸ“ç»ˆç«¯åˆ°æŒ‡å®šä½ç½®
    ///
    /// - Parameters:
    ///   - id: ç»ˆç«¯ ID
    ///   - x, y: æ¸²æŸ“ä½ç½®ï¼ˆé€»è¾‘åæ ‡ï¼‰
    ///   - width, height: ç»ˆç«¯åŒºåŸŸå¤§å°ï¼ˆé€»è¾‘åæ ‡ï¼‰
    ///     - å¦‚æœ > 0ï¼Œè‡ªåŠ¨è®¡ç®— cols/rows å¹¶ resize
    ///     - å¦‚æœ = 0ï¼Œä¸æ‰§è¡Œ resize
    func renderTerminal(_ id: Int, x: Float, y: Float, width: Float = 0, height: Float = 0) -> Bool {
        guard let handle = handle else { return false }
        return terminal_pool_render_terminal(handle, id, x, y, width, height)
    }

    /// ç»“æŸå¸§ï¼ˆç»Ÿä¸€æäº¤æ¸²æŸ“ï¼‰
    func endFrame() {
        guard let handle = handle else { return }
        terminal_pool_end_frame(handle)
    }

    /// è°ƒæ•´æ¸²æŸ“è¡¨é¢å¤§å°
    func resizeSugarloaf(width: Float, height: Float) {
        guard let handle = handle else { return }
        terminal_pool_resize_sugarloaf(handle, width, height)
    }
}

// MARK: - Convenience Extensions

extension TerminalPoolWrapper {

    /// æ¸²æŸ“å¤šä¸ªç»ˆç«¯ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
    ///
    /// ä½¿ç”¨ç¤ºä¾‹ï¼š
    /// ```swift
    /// pool.renderTerminals([
    ///     (id: 1, x: 0, y: 0),
    ///     (id: 2, x: 400, y: 0),
    /// ])
    /// ```
    func renderTerminals(_ terminals: [(id: Int, x: Float, y: Float)]) {
        beginFrame()
        for terminal in terminals {
            _ = renderTerminal(terminal.id, x: terminal.x, y: terminal.y)
        }
        endFrame()
    }
}
