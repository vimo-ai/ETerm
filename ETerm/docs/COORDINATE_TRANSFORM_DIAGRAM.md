# 坐标转换可视化图

## 1. 屏幕坐标系对比

```
┌─────────────────────────────────────────────────────────────┐
│  macOS NSView 坐标系        vs       终端 Grid 坐标系        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  relativeY = panelHeight        Line(0)  ┌──────────┐       │
│           ┌──────────┐                   │  row 0   │ 屏幕顶部
│           │  屏幕顶部 │                   ├──────────┤       │
│           ├──────────┤                   │  row 1   │       │
│           │  row 1   │                   ├──────────┤       │
│           ├──────────┤                   │  row 2   │       │
│           │  row 2   │                   ├──────────┤       │
│           │   ...    │                   │   ...    │       │
│           ├──────────┤                   ├──────────┤       │
│           │  row 22  │                   │  row 22  │       │
│           ├──────────┤                   ├──────────┤       │
│           │  row 23  │                   │  row 23  │ 屏幕底部
│           └──────────┘                   └──────────┘       │
│  relativeY = 0               Line(23)                        │
│                                                              │
│  原点在左下角，Y 向上           原点在左上角，row 向下        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

## 2. 坐标转换流程（修复后）

```
用户点击事件
    │
    │ NSEvent location
    ├─────────────────────────────────────────────────┐
    │                                                  │
    │ 1. macOS NSView 坐标                            │
    │    screenPoint.y = 456.0                        │
    │    (相对于窗口底部的距离)                        │
    │                                                  │
    └─────────────────────────────────────────────────┤
                      │                               │
                      │ RioTerminalView.swift         │
                      ├────────────────────────────────┤
                      │                                │
                      │ 2. 转换为 Panel 相对坐标        │
                      │    relativeY = 456.0 - 30.0    │
                      │             = 426.0            │
                      │                                │
                      └────────────────────────────────┤
                                  │                    │
                                  │ CoordinateMapper   │
                                  ├─────────────────────┤
                                  │                     │
    ┌─────────────────────────────┤ 3. Y 轴翻转         │
    │                             │                     │
    │ yFromTop = contentHeight    │    yFromTop = 480 - 426
    │          - relativeY        │            = 54.0   │
    │                             │                     │
    │ row = yFromTop / cellHeight │    row = 54.0 / 18.0
    │                             │        = 3          │
    │                             │                     │
    │                             └─────────────────────┤
    │                                       │           │
    │                                       │ return    │
    │                             ┌─────────────────────┤
    │                             │                     │
    │                             │ CursorPosition(     │
    │                             │   col: 10,          │
    │                             │   row: 3  ← 屏幕第3行
    │                             │ )                   │
    │                             │                     │
    │                             └─────────────────────┤
    │                                       │           │
    │                                       │ FFI call  │
    └───────────────────────────────────────┤           │
                                  ┌─────────────────────┤
                                  │                     │
                                  │ rio_terminal.rs     │
                                  │                     │
    ┌─────────────────────────────┤ screen_to_absolute()│
    │                             │                     │
    │                             │ // ✅ 正确：直接使用  │
    │ grid_row = screen_row       │ grid_row = 3 - 0    │
    │          - display_offset   │        = 3          │
    │                             │                     │
    │ absolute_row = scrollback   │ absolute_row = 1000 + 3
    │              + grid_row     │              = 1003 │
    │                             │                     │
    │                             └─────────────────────┤
    │                                       │           │
    │                                       │           │
    └───────────────────────────────────────┤           │
                                  ┌─────────────────────┤
                                  │                     │
                                  │ set_selection_absolute()
                                  │                     │
    ┌─────────────────────────────┤                     │
    │                             │                     │
    │ start_grid_row = absolute   │ start = 1003 - 1000
    │                - scrollback  │       = 3          │
    │                             │                     │
    │ Pos::new(Line(grid_row),    │ Pos::new(Line(3),  │
    │          Column(col))       │          Column(10))│
    │                             │                     │
    │                             │ ✅ 正确：Line(3) = 屏幕第3行
    │                             │                     │
    └─────────────────────────────┴─────────────────────┘
```

## 3. 错误的转换（修复前）

```
❌ 错误的 screen_to_absolute() 实现：

    screen_row = 3  (来自 Swift，已经是正确的顺序)
         │
         ├─ rio_screen_row = (24 - 1) - 3  // ❌ 二次翻转
         │                 = 20
         │
         ├─ grid_row = 20 - 0 = 20  // ❌ 错误！
         │
         └─ absolute_row = 1000 + 20 = 1020  // ❌ 错误！

结果：用户点击第 3 行，但选区出现在第 20 行！
```

## 4. 滚动偏移的处理

```
┌──────────────────────────────────────────────────────────┐
│  滚动缓冲区（History Buffer）                             │
│  absolute_row = 0 ~ scrollback_lines-1                   │
│                                                          │
│  ┌────────────┐                                          │
│  │  Line -5   │  ← oldest scrollback line               │
│  ├────────────┤                                          │
│  │  Line -4   │                                          │
│  ├────────────┤                                          │
│  │  Line -3   │                                          │
│  ├────────────┤                                          │
│  │  Line -2   │                                          │
│  ├────────────┤                                          │
│  │  Line -1   │                                          │
│  ├────────────┤  ← 滚动缓冲区边界                         │
│  │  Line 0    │  ← 屏幕顶部（display_offset = 0）        │
│  ├────────────┤     absolute_row = scrollback_lines     │
│  │  Line 1    │                                          │
│  ├────────────┤                                          │
│  │  Line 2    │                                          │
│  ├────────────┤                                          │
│  │  Line 3    │  ← 用户点击这里                          │
│  ├────────────┤                                          │
│  │  Line 4    │                                          │
│  ├────────────┤                                          │
│  │   ...      │                                          │
│  ├────────────┤                                          │
│  │  Line 23   │  ← 屏幕底部                              │
│  └────────────┘                                          │
│                                                          │
│  转换公式：                                               │
│  grid_row = screen_row - display_offset                 │
│           = 3 - 0 = 3                                    │
│                                                          │
│  absolute_row = scrollback_lines + grid_row             │
│               = 1000 + 3 = 1003                          │
└──────────────────────────────────────────────────────────┘

当用户向上滚动 10 行（display_offset = 10）：

┌──────────────────────────────────────────────────────────┐
│  │  Line -15  │                                          │
│  ├────────────┤                                          │
│  │  Line -14  │                                          │
│  ├────────────┤                                          │
│  │  Line -13  │                                          │
│  ├────────────┤                                          │
│  │  Line -12  │                                          │
│  ├────────────┤                                          │
│  │  Line -11  │                                          │
│  ├────────────┤                                          │
│  │  Line -10  │  ← 屏幕顶部（display_offset = 10）       │
│  ├────────────┤     screen_row = 0                       │
│  │  Line -9   │                                          │
│  ├────────────┤                                          │
│  │  Line -8   │                                          │
│  ├────────────┤                                          │
│  │  Line -7   │  ← 用户点击这里（screen_row = 3）        │
│  ├────────────┤                                          │
│  │   ...      │                                          │
│  ├────────────┤                                          │
│  │  Line 13   │  ← 屏幕底部                              │
│  └────────────┘                                          │
│                                                          │
│  转换公式：                                               │
│  grid_row = screen_row - display_offset                 │
│           = 3 - 10 = -7                                  │
│                                                          │
│  absolute_row = scrollback_lines + grid_row             │
│               = 1000 + (-7) = 993                        │
│                                                          │
│  ✅ 正确：Line(-7) 对应滚动缓冲区中的行                   │
└──────────────────────────────────────────────────────────┘
```

## 5. 关键要点

1. **Swift 的 screenToGrid()** 已经完成了 Y 轴翻转
   - 输入：NSView 坐标（原点在左下角）
   - 输出：终端坐标（row = 0 在顶部）

2. **Rust 不应该再次翻转**
   - 直接使用 `screen_row`
   - 只需考虑 `display_offset`（滚动偏移）

3. **Grid 坐标可以是负数**
   - 负数表示在滚动缓冲区中
   - 范围：`[-scrollback_lines, screen_lines)`

4. **绝对坐标永远非负**
   - 范围：`[0, scrollback_lines + screen_lines)`
   - 用于搜索结果的持久化存储
