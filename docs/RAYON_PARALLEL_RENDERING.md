# Rayon å¹¶å‘æ¸²æŸ“ä¼˜åŒ–å®ç°æ€»ç»“

## æ”¹åŠ¨æ¦‚è¿°

ä¼˜åŒ– Rust ç»ˆç«¯æ¸²æŸ“æ€§èƒ½ï¼Œä½¿ç”¨ Rayon åº“å®ç°è¡Œçº§å¹¶å‘æ¸²æŸ“ã€‚

**ç›®æ ‡**: å°†ä¸²è¡Œçš„è¡Œæ¸²æŸ“æ”¹ä¸ºå¹¶å‘ï¼Œé™ä½å¤§é‡å†…å®¹æ¸²æŸ“æ—¶çš„ CPU è€—æ—¶ã€‚

## æ€§èƒ½é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜
- Rust Render è€—æ—¶ 5873msï¼ˆç²˜è´´å¤§é‡å†…å®¹ç»™ Claude æ—¶ï¼‰
- éœ€è¦æ¸²æŸ“ 64 è¡Œ Ã— 218 åˆ—ï¼ˆçº¦ 13,952 ä¸ªå­—ç¬¦ï¼‰
- æ¯è¡Œä¸²è¡Œå¤„ç†ï¼š`get_row_cells()` â†’ è§£æé¢œè‰² â†’ åˆ›å»º CString â†’ è°ƒç”¨ Sugarloaf API
- æ¯è¡Œéƒ½è¦ lock ç»ˆç«¯ä¸€æ¬¡ï¼ˆ2 ä¸ªç»ˆç«¯ Ã— 64 è¡Œ = 128 æ¬¡ lock/å¸§ï¼‰

### ç“¶é¢ˆè¯†åˆ«
```
æ€»è€—æ—¶ 5873ms
â”œâ”€â”€ CPU å¯†é›†å‹æ“ä½œï¼ˆå¯å¹¶å‘ä¼˜åŒ–ï¼‰
â”‚   â”œâ”€â”€ terminal.get_row_cells() - 128 æ¬¡ lock/unlock
â”‚   â”œâ”€â”€ é¢œè‰²è§£æå’Œå½’ä¸€åŒ– - 13,952 æ¬¡
â”‚   â”œâ”€â”€ format!() å­—ç¬¦ä¸²æ ¼å¼åŒ– - 13,952 æ¬¡
â”‚   â””â”€â”€ std::char::from_u32() - 13,952 æ¬¡
â”‚
â””â”€â”€ ä¸²è¡Œç“¶é¢ˆï¼ˆæ— æ³•å¹¶å‘ï¼‰
    â””â”€â”€ Sugarloaf API è°ƒç”¨ - 13,952 æ¬¡ï¼ˆéœ€è¦ä¸²è¡Œï¼‰
```

## ä¼˜åŒ–æ–¹æ¡ˆ

### è®¾è®¡æ€è·¯
å°†æ¸²æŸ“è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š
1. **é˜¶æ®µ 1ï¼ˆå¹¶å‘ï¼‰**: CPU å¯†é›†å‹æ•°æ®æå–å’Œè§£æ
2. **é˜¶æ®µ 2ï¼ˆä¸²è¡Œï¼‰**: Sugarloaf API è°ƒç”¨

### æ¶æ„æ”¹åŠ¨

#### 1. æ·»åŠ ä¾èµ–
**æ–‡ä»¶**: `rio/sugarloaf-ffi/Cargo.toml`
```toml
rayon = "1.8"
```

#### 2. ä¸­é—´æ•°æ®ç»“æ„
**æ–‡ä»¶**: `rio/sugarloaf-ffi/src/rio_terminal.rs`

```rust
/// å•ä¸ªå­—ç¬¦çš„æ¸²æŸ“æ•°æ®ï¼ˆå¹¶å‘é˜¶æ®µè§£æåçš„ä¸­é—´æ ¼å¼ï¼‰
#[derive(Debug, Clone)]
struct CharRenderData {
    char_str: String,
    fg_r: f32,
    fg_g: f32,
    fg_b: f32,
    fg_a: f32,
    has_bg: bool,
    bg_r: f32,
    bg_g: f32,
    bg_b: f32,
    bg_a: f32,
    glyph_width: f32,
    has_cursor: bool,
    cursor_r: f32,
    cursor_g: f32,
    cursor_b: f32,
    cursor_a: f32,
    flags: u32,
}

/// å•è¡Œçš„æ¸²æŸ“æ•°æ®
#[derive(Debug, Clone)]
struct RowRenderData {
    chars: Vec<CharRenderData>,
    is_cursor_report: bool,
}
```

#### 3. æ ¸å¿ƒé€»è¾‘æ”¹åŠ¨
**æ–‡ä»¶**: `rio/sugarloaf-ffi/src/rio_terminal.rs` - `render_terminal_content()`

**æ”¹åŠ¨å‰ï¼ˆä¸²è¡Œï¼‰**:
```rust
for row_index in 0..lines_to_render {
    let cells = terminal.get_row_cells(absolute_row);  // ğŸ”’ Lock

    for cell in cells {
        // è§£æé¢œè‰²ã€åˆ›å»ºå­—ç¬¦ä¸²
        let char_str = ...;
        let fg_r = ...;

        // ç«‹å³è°ƒç”¨ API
        sugarloaf_content_add_text_decorated(...);
    }
}
```

**æ”¹åŠ¨åï¼ˆå¹¶å‘ï¼‰**:
```rust
use rayon::prelude::*;

// ğŸ”¥ é˜¶æ®µ 1ï¼šå¹¶å‘æå–å’Œè§£ææ‰€æœ‰è¡Œçš„æ•°æ®
let rows_data: Vec<RowRenderData> = (0..lines_to_render)
    .into_par_iter()  // Rayon å¹¶è¡Œè¿­ä»£å™¨
    .map(|row_index| {
        // æ¯è¡Œå„è‡ª lock å¹¶æå–æ•°æ®
        let cells = terminal.get_row_cells(absolute_row);

        // è§£æé¢œè‰²ã€æ ·å¼ç­‰ï¼ˆCPU å¯†é›†å‹æ“ä½œï¼‰
        let char_data_vec = cells.iter().map(|cell| {
            CharRenderData {
                char_str: format_char(cell),
                fg_r: cell.fg_r as f32 / 255.0,
                // ... å…¶ä»–å­—æ®µ
            }
        }).collect();

        RowRenderData { chars: char_data_vec, ... }
    })
    .collect();

// ğŸ”¥ é˜¶æ®µ 2ï¼šä¸²è¡Œè°ƒç”¨ Sugarloaf API
for row_data in rows_data {
    for char_data in row_data.chars {
        sugarloaf_content_add_text_decorated(
            char_data.fg_r,
            char_data.fg_g,
            // ...
        );
    }
}
```

## æ€§èƒ½é¢„æœŸ

### ç†è®ºåŠ é€Ÿæ¯”
- **CPU æ ¸å¿ƒæ•°**: å‡è®¾ 8 æ ¸ï¼ˆM1/M2ï¼‰
- **å¹¶å‘æ•ˆç‡**: è€ƒè™‘ overheadï¼Œå®é™…åŠ é€Ÿ 4-6 å€
- **é¢„æœŸè€—æ—¶**: 5873ms â†’ 1000-1500ms

### æµ‹è¯•åœºæ™¯
1. ç²˜è´´å¤§é‡å†…å®¹ç»™ Claudeï¼ˆè§¦å‘å¤§è§„æ¨¡æ¸²æŸ“ï¼‰
2. å¿«é€Ÿæ»šåŠ¨å†å²è®°å½•
3. åŒæ—¶æ˜¾ç¤ºå¤šä¸ªç»ˆç«¯

## å¹¶å‘å®‰å…¨ä¿è¯

### Lock ç­–ç•¥
- æ¯è¡Œç‹¬ç«‹ lockï¼š`terminal.get_row_cells(absolute_row)` å†…éƒ¨ä¼š lock
- Lock ç²’åº¦ç»†åŒ–ï¼šä»"æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹"é™åˆ°"å•è¡Œæ•°æ®æå–"
- æ— ç«äº‰é£é™©ï¼šä¸åŒè¡Œçš„æ•°æ®æå–å®Œå…¨ç‹¬ç«‹

### æ•°æ®ç»“æ„
- **CharRenderData**: çº¯æ•°æ®ï¼Œæ— å…±äº«çŠ¶æ€
- **RowRenderData**: çº¯æ•°æ®ï¼Œæ— å…±äº«çŠ¶æ€
- **Rayon**: è‡ªåŠ¨ç®¡ç†çº¿ç¨‹æ± ï¼Œwork-stealing è°ƒåº¦

## å®ç°ç»†èŠ‚

### å…³é”®ç‚¹
1. **ä¿æŒåŸæœ‰é€»è¾‘ä¸å˜**: åªæ”¹å˜æ‰§è¡Œé¡ºåºï¼Œä¸æ”¹å˜æ¸²æŸ“ç»“æœ
2. **ä¸¤é˜¶æ®µè®¾è®¡**: å¹¶å‘æå–æ•°æ® â†’ ä¸²è¡Œè°ƒç”¨ API
3. **ä¸­é—´æ•°æ®ç»“æ„**: è§£è€¦æ•°æ®è§£æå’Œ API è°ƒç”¨
4. **Rayon è‡ªåŠ¨è°ƒåº¦**: æ— éœ€æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹

### ä»£ç ä½ç½®
- `rio/sugarloaf-ffi/Cargo.toml` - æ·»åŠ  rayon ä¾èµ–
- `rio/sugarloaf-ffi/src/rio_terminal.rs` - æ ¸å¿ƒæ¸²æŸ“é€»è¾‘

### ç¼–è¯‘éªŒè¯
```bash
# ç¼–è¯‘ Rust åº“
cd rio
cargo build -p sugarloaf-ffi

# ç¼–è¯‘å®Œæ•´é¡¹ç›®
xcodebuild -project ETerm/ETerm.xcodeproj -scheme ETerm -configuration Debug build
```

**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

## åç»­ä¼˜åŒ–æ–¹å‘

### å¦‚æœå¹¶å‘ä¼˜åŒ–åä»æœ‰æ€§èƒ½é—®é¢˜
1. **åˆ†ææ–°ç“¶é¢ˆ**: ä½¿ç”¨ Instruments åˆ†æè€—æ—¶åˆ†å¸ƒ
2. **å¯èƒ½çš„ç“¶é¢ˆ**:
   - Sugarloaf API è°ƒç”¨ï¼ˆä¸²è¡Œï¼‰
   - CString åˆ›å»ºï¼ˆå¯ç¼“å­˜ï¼‰
   - Content å†…å­˜åˆ†é…ï¼ˆå¯é¢„åˆ†é…ï¼‰

### è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®
1. é¢„åˆ†é… Content å®¹é‡ï¼š`Vec::with_capacity(expected_chars)`
2. CString ç¼“å­˜ï¼šå¤ç”¨å¸¸è§å­—ç¬¦çš„ CString
3. æ‰¹é‡ API è°ƒç”¨ï¼šè®¾è®¡æ‰¹é‡æ·»åŠ æ–‡æœ¬çš„ API

## æµ‹è¯•æ¸…å•

- [ ] ç»ˆç«¯å†…å®¹æ˜¾ç¤ºæ­£ç¡®ï¼ˆå­—ç¬¦ã€é¢œè‰²ã€æ ·å¼ï¼‰
- [ ] å…‰æ ‡ä½ç½®å’Œæ ·å¼æ­£ç¡®
- [ ] é€‰åŒºæ˜¾ç¤ºæ­£å¸¸
- [ ] å¤šç»ˆç«¯åŒæ—¶æ¸²æŸ“ä¸ä¼šå´©æºƒ
- [ ] å¤§é‡å†…å®¹ç²˜è´´æ—¶æ€§èƒ½æå‡æ˜æ˜¾
- [ ] æ— æ­»é”æˆ–ç«äº‰æ¡ä»¶

## é£é™©è¯„ä¼°

### ä½é£é™©
- âœ… é€»è¾‘ç­‰ä»·æ€§ï¼šå¹¶å‘ç‰ˆæœ¬ä¸ä¸²è¡Œç‰ˆæœ¬å®Œå…¨ç­‰ä»·
- âœ… ç±»å‹å®‰å…¨ï¼šRust ç¼–è¯‘å™¨ä¿è¯æ•°æ®ç«äº‰å®‰å…¨
- âœ… æ¸è¿›å¼å›é€€ï¼šå¦‚æœ‰é—®é¢˜å¯ç«‹å³å›é€€åˆ°ä¸²è¡Œç‰ˆæœ¬

### éœ€è¦ç›‘æ§
- âš ï¸ å†…å­˜ä½¿ç”¨ï¼šä¸­é—´æ•°æ®ç»“æ„ä¼šå ç”¨é¢å¤–å†…å­˜
- âš ï¸ å°‘é‡è¡Œæ¸²æŸ“ï¼šå¹¶å‘å¼€é”€å¯èƒ½è¶…è¿‡æ”¶ç›Šï¼ˆ< 16 è¡Œï¼‰

## æ€»ç»“

é€šè¿‡ Rayon å¹¶å‘ä¼˜åŒ–ï¼Œå°† CPU å¯†é›†å‹çš„æ•°æ®è§£ææ“ä½œå¹¶è¡ŒåŒ–ï¼Œç†è®ºåŠ é€Ÿæ¯” 4-8 å€ã€‚å®é™…æ•ˆæœéœ€è¦åœ¨çœŸå®åœºæ™¯ä¸­æµ‹è¯•éªŒè¯ã€‚
