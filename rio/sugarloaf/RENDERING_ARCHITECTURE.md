# Sugarloaf æ¸²æŸ“æ¶æ„è¯´æ˜

## å½“å‰æ¶æ„ (2025-12)

**ETerm ä½¿ç”¨ Skia æ¸²æŸ“å¼•æ“ï¼ˆmacOS onlyï¼‰**

```
ETerm (Swift UI)
    â†“
Sugarloaf (Rust)
    â†“
Skia (é€šè¿‡ CAMetalLayer)
    â†“
Metal (macOS GPU)
```

## å†å²å˜æ›´

### 2025-12: WGPU è·¨å¹³å°æ¸²æŸ“å™¨æ¸…ç†

**ç§»é™¤åŸå› **: ETerm å®šä½ä¸º macOS ä¸“ç”¨ç»ˆç«¯ï¼Œä¸éœ€è¦è·¨å¹³å°æ¸²æŸ“æ”¯æŒã€‚

**å·²æ¸…ç†å†…å®¹**:
- âœ… WGPU åˆå§‹åŒ–å’Œ Context å­—æ®µ
- âœ… è·¨å¹³å°ä»£ç  (`#[cfg(not(target_os = "macos"))]`)
- âœ… Filters æ¨¡å— (WGPU-based æ»¤é•œç³»ç»Ÿ)
- âœ… Layer/Quad/RichText WGPU æ¸²æŸ“å™¨ç»„ä»¶
- âœ… WGPU å…¼å®¹æ–¹æ³• (`supports_f16`, `max_texture_dimension_2d` ç­‰)

**ä¿ç•™å†…å®¹**:
- âœ… Skia æ¸²æŸ“è·¯å¾„ (`sugarloaf/src/sugarloaf.rs:375`)
- âœ… æ–‡æœ¬å¡‘å½¢ (HarfBuzz) å’Œå­—å½¢ç¼“å­˜
- âœ… Quad æ•°æ®ç»“æ„ (ç”¨äºæè¿°èƒŒæ™¯/è¾¹æ¡†ï¼Œç»™ Skia ä½¿ç”¨)
- âœ… Metal backend (Skia åº•å±‚ä¾èµ–)

**ä»£ç çŠ¶æ€**:
- å·²æ¸…ç†çš„ä»£ç ä»¥**æ³¨é‡Šå½¢å¼ä¿ç•™**åœ¨åŸä½ç½®
- å¯é€šè¿‡ Git å†å² (commit: TODO) å®Œæ•´æ¢å¤
- **é•¿æœŸç¨³å®šåå°†å½»åº•åˆ é™¤æ³¨é‡Šä»£ç **

---

## å¾…æ¸…ç†é¡¹ (ç¬¬äºŒé˜¶æ®µ - å¯é€‰)

### ğŸ” 1. æœªä½¿ç”¨çš„ Skia é«˜çº§ç‰¹æ€§

**ä½ç½®**: `sugarloaf/src/sugarloaf.rs`, `context/mod.rs`

**å¾…æ£€æŸ¥**:
- [ ] å¤æ‚çš„å›¾å½¢æ•ˆæœ (é˜´å½±ã€æ¨¡ç³Šç­‰) æ˜¯å¦å®é™…ä½¿ç”¨
- [ ] é«˜çº§æ··åˆæ¨¡å¼
- [ ] æœªä½¿ç”¨çš„ Skia filter/effect

**æ ‡è®°**: æœç´¢ä»£ç ä¸­çš„ `TODO: Skia Advanced Feature`

---

### ğŸ” 2. å†—ä½™çš„æŠ½è±¡å±‚

**ä½ç½®**: `components/core/`, `layout/`

**å¾…æ£€æŸ¥**:
- [ ] åªæœ‰å•ä¸€å®ç°çš„ trait
- [ ] è¿‡åº¦è®¾è®¡çš„æ¥å£ï¼ˆä¾‹å¦‚ä¸º"é€šç”¨æ€§"è®¾è®¡ä½†åªæœ‰ Skia å®ç°ï¼‰
- [ ] å¤šå±‚é—´æ¥è°ƒç”¨ä½†æ²¡æœ‰å®é™…å˜åŒ–çš„ä»£ç 

**æ ‡è®°**: æœç´¢ä»£ç ä¸­çš„ `TODO: Abstraction Layer`

**ç¤ºä¾‹**:
```rust
// å¦‚æœæŸä¸ª trait åªæœ‰ä¸€ä¸ªå®ç°ï¼Œä¸”æœªæ¥ä¸ä¼šæœ‰å…¶ä»–å®ç°
trait Renderer {
    fn render(&self);
}

// åªæœ‰ä¸€ä¸ªå®ç° â†’ å¯ä»¥è€ƒè™‘ç›´æ¥ä½¿ç”¨ SkiaRenderer
struct SkiaRenderer;
impl Renderer for SkiaRenderer { ... }
```

---

### ğŸ” 3. æ€§èƒ½ä¼˜åŒ–ä»£ç çš„æ¸…ç†

**ä½ç½®**: `layout/content.rs`, `font/`, `sugarloaf/state.rs`

**å¾…æ£€æŸ¥**:
- [ ] LRU ç¼“å­˜ç­–ç•¥æ˜¯å¦è¿‡åº¦å¤æ‚
- [ ] æ˜¯å¦æœ‰æœªä½¿ç”¨çš„é¢„è®¡ç®—/é¢„åŠ è½½é€»è¾‘
- [ ] å­—å½¢ç¼“å­˜ç­–ç•¥æ˜¯å¦å¯ä»¥ç®€åŒ–

**æ ‡è®°**: æœç´¢ä»£ç ä¸­çš„ `TODO: Performance Optimization`

**æ³¨æ„**: è¿™ç±»æ¸…ç†éœ€è¦**æ€§èƒ½æµ‹è¯•éªŒè¯**ï¼Œé¿å…å½±å“å®é™…ä½“éªŒã€‚

---

## æ¸…ç†åŸåˆ™

1. **æ¸è¿›å¼æ¸…ç†** - æ¯æ¬¡æ¸…ç†åç¼–è¯‘æµ‹è¯•é€šè¿‡
2. **ä¿ç•™æ³¨é‡Š** - çŸ­æœŸå†…ä»¥æ³¨é‡Šå½¢å¼ä¿ç•™ä»£ç 
3. **Git å†å²** - ä¾èµ– Git ä¿å­˜å®Œæ•´å†å²
4. **åŠŸèƒ½ä¼˜å…ˆ** - ä¸ç ´åç°æœ‰åŠŸèƒ½
5. **æ–‡æ¡£åŒæ­¥** - æ¸…ç†æ—¶æ›´æ–°æ­¤æ–‡æ¡£

---

## æ¢å¤æŒ‡å—

å¦‚æœæœªæ¥éœ€è¦æ¢å¤ WGPU æ¸²æŸ“å™¨ï¼š

```bash
# 1. æŸ¥çœ‹æ¸…ç†å‰çš„ commit
git log --grep="WGPU" --oneline

# 2. æ¢å¤ç‰¹å®šæ–‡ä»¶
git checkout <commit-hash> -- sugarloaf/src/components/filters
git checkout <commit-hash> -- sugarloaf/src/components/layer
# ... å…¶ä»–æ–‡ä»¶

# 3. å–æ¶ˆæ³¨é‡Š context/mod.rs ä¸­çš„ WGPU åˆå§‹åŒ–ä»£ç 
```

---

## ç»´æŠ¤è€…æ³¨æ„

**AI å¼€å‘æ—¶çš„æ³¨æ„äº‹é¡¹**:
- å½“å‰æ¶æ„æ˜¯ **Skia only**ï¼Œä¸è¦è¯¯è®¤ä¸ºæ˜¯ Skia + WGPU åŒæ¸²æŸ“å™¨
- æ³¨é‡Šçš„ WGPU ä»£ç **ä¸åº”æ¢å¤**ï¼Œé™¤éæœ‰æ˜ç¡®çš„è·¨å¹³å°éœ€æ±‚
- ä¿®æ”¹æ¸²æŸ“é€»è¾‘æ—¶ï¼Œåªéœ€å…³æ³¨ `sugarloaf.rs` ä¸­çš„ Skia æ¸²æŸ“è·¯å¾„

**å…³é”®æ–‡ä»¶**:
- `sugarloaf/src/sugarloaf.rs:375` - Skia æ¸²æŸ“ä¸»é€»è¾‘
- `sugarloaf/src/context/mod.rs:62` - Context åˆå§‹åŒ– (åªæœ‰ Skia)
- `sugarloaf/src/components/mod.rs` - æ•°æ®ç»“æ„å®šä¹‰ (Quad)
