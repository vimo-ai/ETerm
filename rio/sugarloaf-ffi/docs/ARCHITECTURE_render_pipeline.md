# æ¸²æŸ“ç®¡çº¿æ¶æ„

## æ•°æ®æµ

```
PTY (bash)
    â”‚ æµå¼ bytes
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ANSI   â”‚  è§£æè½¬ä¹‰åºåˆ—
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ å­—ç¬¦ + å‘½ä»¤
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Grid   â”‚  Crosswords å•å…ƒæ ¼å­˜å‚¨
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ state å¿«ç…§
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Render  â”‚  å­—å½¢ â†’ Image
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
  Screen
```

## å„é˜¶æ®µ

| é˜¶æ®µ | ä½ç½® | è€—æ—¶ | åå | ç¼“å­˜ | å¤‡æ³¨ |
|-----|------|------|------|------|------|
| PTYâ†’Grid | rio-backend/performer | 85Î¼s/1KB | 12 MB/s | - | ä¸æ˜¯ç“¶é¢ˆ |
| Gridâ†’State | domain/aggregates/terminal | 30Î¼s/è¡Œ | - | - | **ç“¶é¢ˆï¼** |
| Stateâ†’Render | render/renderer | ~4Î¼s/è¡Œ | - | L1/L2 | ç¼“å­˜å‘½ä¸­æ—¶ 0 |

## Benchmark æ•°æ® (debug build)

### å°ç»ˆç«¯ 80Ã—24ï¼Œæ— å†å²
```
å…¨å±æ›´æ–°:
  state():        1220Âµs ( 11.7%)
  render Ã— 24:    9172Âµs ( 88.0%)  â† render_line cache miss ä¸»å¯¼
  Total:         10393Âµs

ç“¶é¢ˆ: render_line (é¦–æ¬¡æ¸²æŸ“ï¼Œæ— ç¼“å­˜)
```

### å¤§ç»ˆç«¯ 100Ã—200ï¼Œæ— å†å²
```
å…¨å±æ›´æ–° (200è¡Œ):
  state():       19827Âµs ( 20.4%)
  render Ã— 200:  77225Âµs ( 79.6%)
  Total:         97052Âµs
  FPS ä¸Šé™:      10.3

å•è¡Œæ›´æ–°:
  state():       18990Âµs ( 96.2%)
  render Ã— 200:    759Âµs (  3.8%)  â† ç¼“å­˜å‘½ä¸­ï¼Œ429x åŠ é€Ÿ
  Total:         19749Âµs

ç“¶é¢ˆ: state() (ç¼“å­˜å‘½ä¸­å)
```

### å¤§ç»ˆç«¯ 100Ã—50 + 1951è¡Œå†å² (çœŸå®åœºæ™¯)
```
å•è¡Œæ›´æ–°:
  state():       60297Âµs ( 99.6%)  â† éå† 2001 è¡Œ
  render Ã— 50:     211Âµs (  0.3%)
  Total:         60510Âµs (60.51ms)
  FPS ä¸Šé™:      16.5

state() åˆ†æ:
  éå†è¡Œæ•°:      2001
  æ¯è¡Œè€—æ—¶:      30.13Âµs

âš ï¸ ç“¶é¢ˆ: state() å  99.6%ï¼Œå†å²è¶Šå¤šè¶Šæ…¢
```

### ç»“è®º

| åœºæ™¯ | ç“¶é¢ˆ | å æ¯” |
|-----|------|------|
| é¦–æ¬¡æ¸²æŸ“/æ¸…å± | render_line (cache miss) | ~80% |
| æ­£å¸¸æ›´æ–°æ— å†å² | state() | ~96% |
| æ­£å¸¸æ›´æ–°æœ‰å†å² | state() | **~99.6%** |

**å…³é”®å‘ç°**: æœ‰æ»šåŠ¨å†å²æ—¶ï¼Œstate() æ¯å¸§éå†å…¨éƒ¨å†å²è¡Œï¼ˆè€Œéä»…å¯è§è¡Œï¼‰ï¼Œå¯¼è‡´å¸§æ—¶é—´çº¿æ€§å¢é•¿ã€‚

### PTY â†’ Grid è¯¦æƒ…

```
Plain Text 1KB:    85Î¼s,  12 MB/s
ANSI 1KB:          86Î¼s,  12 MB/s
Complex ANSI 1KB: 395Î¼s,  2.6 MB/s  â† æ¯å­—ç¬¦æ¢è‰²æ…¢ 4 å€
ANSI 10KB:        885Î¼s,  11.6 MB/s
```

ç»“è®ºï¼šæ­£å¸¸åœºæ™¯è¶³å¤Ÿå¿«ï¼Œæç«¯è¾“å‡ºï¼ˆyes/urandomï¼‰ä¼šå»¶è¿Ÿä½†ä¸ä¸¢æ•°æ®

### Grid â†’ State è¯¦æƒ…

```
render_terminal() å…¥å£
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  is_damaged()?  â”‚  è½»é‡æ£€æµ‹ï¼ˆCrosswords LineDamageï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚       â”‚
     å¦       æ˜¯
      â”‚       â”‚
      â–¼       â–¼
   è·³è¿‡    state()  â† å…¨é‡å¿«ç…§ï¼Œ7msï¼
              â”‚
              â”œâ”€â”€ GridData::from_crosswords()
              â”‚     â””â”€â”€ éå† total_linesï¼ˆå†å²+å±å¹•ï¼‰
              â”‚     â””â”€â”€ æ¯è¡Œ convert_row() + ç®— hash
              â”‚
              â”œâ”€â”€ CursorView
              â”œâ”€â”€ SelectionView
              â””â”€â”€ SearchView
```

é—®é¢˜ï¼š
- `state()` éå†å…¨éƒ¨å†å²ï¼ˆ1024è¡Œï¼‰ï¼Œè€Œéå¯è§åŒºåŸŸï¼ˆ24è¡Œï¼‰
- æ¯æ¬¡éƒ½é‡ç®—æ‰€æœ‰è¡Œçš„ hashï¼Œæ— è§† LineDamage
- å³ä½¿åªæ”¹ 1 è¡Œï¼Œä¹Ÿè¦å…¨é‡å¿«ç…§

### State â†’ Render è¯¦æƒ…

```
state å¿«ç…§
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for line in rows â”‚  éå†æ‰€æœ‰å¯è§è¡Œ
â”‚   render_line()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ text_hash = row_hashes[line]        â”‚  â† é¢„è®¡ç®—ï¼ŒO(1)
    â”‚ state_hash = cursor/sel/searchæœ¬è¡Œ  â”‚  â† è½»é‡è®¡ç®—
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    cache.get(text_hash, state_hash)
          â”‚
          â”œâ”€â”€ FullHit â†’ è¿”å› Imageï¼ˆ0 å¼€é”€ï¼‰
          â”‚
          â”œâ”€â”€ LayoutHit â†’ å¤ç”¨ GlyphLayoutï¼Œé‡ç»˜
          â”‚
          â””â”€â”€ Miss â†’ compute_glyph_layout + æ¸²æŸ“
```

ä½ç½®ï¼š`render/renderer.rs:59`

ç¼“å­˜è®¾è®¡ï¼š
- **text_hash**: è¡Œå†…å®¹ hashï¼Œåœ¨ `state()` æ—¶é¢„è®¡ç®—
- **state_hash**: åªå«å½±å“æœ¬è¡Œçš„çŠ¶æ€ï¼ˆcursor/selection/searchï¼‰
- **FullHit ç‡**: 99%+ï¼ˆå†…å®¹ä¸å˜ + çŠ¶æ€ä¸å˜ï¼‰

ç»“è®ºï¼š`render_line` æœ¬èº«é«˜æ•ˆï¼Œç“¶é¢ˆåœ¨ `state()` çš„é¢„è®¡ç®—é˜¶æ®µ

## é”å±‚æ¬¡ä¸ç«äº‰åˆ†æ

### é”å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Terminal Mutex                           â”‚
â”‚  ä½ç½®: terminal_pool.rs / terminal_store.rs                 â”‚
â”‚  ç±»å‹: Arc<Mutex<Terminal>>                                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Crosswords RwLock                      â”‚   â”‚
â”‚  â”‚  ä½ç½®: domain/aggregates/terminal.rs                â”‚   â”‚
â”‚  â”‚  ç±»å‹: Arc<RwLock<Crosswords<FFIEventListener>>>    â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  âš ï¸ PTY çº¿ç¨‹ç›´æ¥æŒæœ‰æ­¤å¼•ç”¨ï¼Œç»•è¿‡ Terminal Mutex    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸¤æ¡è®¿é—®è·¯å¾„

```
æ¸²æŸ“çº¿ç¨‹:                          PTY çº¿ç¨‹:
    â”‚                                  â”‚
    â–¼                                  â”‚
Terminal.try_lock()                    â”‚
    â”‚ æˆåŠŸ                             â”‚
    â–¼                                  â”‚
state() {                              â”‚
    crosswords.read()  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º crosswords.try_write()
    â”‚                                  â”‚ å¤±è´¥ï¼ˆread è¢«æŒæœ‰ï¼‰
    â”‚ æŒæœ‰ 60msï¼                      â”‚
    â”‚                                  â–¼
    â”‚                              buffer ç§¯ç´¯
    â”‚                                  â”‚
    â”‚                              buffer æ»¡ï¼Ÿ
    â”‚                                  â”‚ æ˜¯
    â”‚                                  â–¼
    â”‚                         crosswords.write() é˜»å¡
    â”‚                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ ç­‰å¾… read é‡Šæ”¾
                                       â”‚
    read é‡Šæ”¾  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
}
```

### ç«äº‰åœºæ™¯åˆ†æ

| åœºæ™¯ | æ¸²æŸ“ç«¯ | PTY ç«¯ | å½±å“ |
|-----|--------|--------|------|
| æ­£å¸¸ | try_lock æˆåŠŸï¼Œread 60ms | try_write å¤±è´¥ï¼Œbuffer ç§¯ç´¯ | PTY æš‚æ—¶æ— æ³•å†™å…¥ |
| æœ€å | read æŒæœ‰ 60ms | buffer æ»¡ï¼Œwrite é˜»å¡ | **PTY é˜»å¡ 60ms** |
| æ¸²æŸ“å¿™ | try_lock å¤±è´¥ï¼Œè·³è¿‡ | æ­£å¸¸å†™å…¥ | ä¸¢å¸§ä½†ä¸å¡ |

### æ—¶é—´çº¿ï¼ˆæœ€åæƒ…å†µï¼‰

```
æ—¶é—´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
      0ms                              60ms                    120ms
       â”‚                                â”‚                        â”‚
æ¸²æŸ“   â”‚â—„â”€â”€â”€â”€ state() æŒæœ‰ read lock â”€â”€â”€â–ºâ”‚                        â”‚
       â”‚                                â”‚                        â”‚
PTY    â”‚ try_write âœ— â”‚ try_write âœ— â”‚ bufferæ»¡ â”‚â—„â”€ write é˜»å¡ â”€â–ºâ”‚ ç»§ç»­
       â”‚             â”‚             â”‚          â”‚                  â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¾“å‡ºå»¶è¿Ÿç´¯ç§¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
```

### é—®é¢˜æ ¹å› 

1. **state() æŒæœ‰ read lock æ—¶é—´è¿‡é•¿**ï¼ˆ60msï¼‰
   - éå† 2001 è¡Œåšå¿«ç…§
   - è¿™æœŸé—´ PTY æ— æ³•å†™å…¥

2. **PTY å’Œæ¸²æŸ“å…±äº« Crosswords RwLock**
   - PTY ç›´æ¥æŒæœ‰ Arc å¼•ç”¨ï¼Œç»•è¿‡ Terminal Mutex
   - è®¾è®¡åˆç†ï¼ˆé¿å…æ­»é”ï¼‰ï¼Œä½† read æ—¶é—´å¤ªé•¿

3. **ä¼˜åŒ– state() å¯åŒæ—¶è§£å†³**
   - å‡å°‘ read lock æŒæœ‰æ—¶é—´
   - PTY å†™å…¥å»¶è¿Ÿé™ä½
   - æ•´ä½“å“åº”æ€§æå‡

### Benchmark éªŒè¯ (`bench_lock_contention_realistic`)

| æ¨¡å¼ | å†å²è¡Œ | state() è€—æ—¶ | PTY é˜»å¡ç­‰å¾… |
|-----|--------|-------------|-------------|
| Release | 500 | 1.4ms | 1.7ms (max) |
| Debug | 2000 | **62ms** | **62.8ms (max)** |

```
Debug æ¨¡å¼ + 2000 è¡Œå†å²:

æ¸²æŸ“çº¿ç¨‹ (state() è°ƒç”¨):
   è°ƒç”¨æ¬¡æ•°: 26
   å¹³å‡è€—æ—¶: 62018Âµs (62.0ms)
   æœ€å¤§è€—æ—¶: 62894Âµs (62.9ms)

PTY çº¿ç¨‹ (write è°ƒç”¨):
   é˜»å¡æ¬¡æ•°: 26
   å¹³å‡ç­‰å¾…: 61959Âµs (62.0ms)
   æœ€å¤§ç­‰å¾…: 62828Âµs (62.8ms)

ğŸ“Š ç»“è®º:
   âš ï¸ æ£€æµ‹åˆ° 26 æ¬¡é”ç«äº‰é˜»å¡
   æœ€å¤§å»¶è¿Ÿ: 62.8msï¼ˆè¾“å…¥ä¼šæ„ŸçŸ¥å¡é¡¿ï¼‰
```

**å®æµ‹è¯å®**ï¼šstate() æŒé”æ—¶é—´ = PTY é˜»å¡æ—¶é—´ï¼Œ62ms ä¼šé€ æˆæ˜æ˜¾è¾“å…¥å»¶è¿Ÿã€‚

## TOCTOU é—®é¢˜åˆ†æ

### å½“å‰æµç¨‹ï¼ˆ3 æ¬¡ try_lockï¼‰

```rust
// ç¬¬ 1 æ¬¡ try_lock
let is_damaged = terminal.try_lock()?.is_damaged();
// é‡Šæ”¾é” â† TOCTOU çª—å£ 1

if !is_damaged { return; }  // å¯èƒ½æ¼æ¸²æŸ“

// ç¬¬ 2 æ¬¡ try_lock
let state = terminal.try_lock()?.state();
// é‡Šæ”¾é” â† TOCTOU çª—å£ 2

// ... æ¸²æŸ“ ...

// ç¬¬ 3 æ¬¡ try_lock
terminal.try_lock()?.reset_damage();  // å¯èƒ½ reset æ‰æ–° damage
```

### é—®é¢˜åœºæ™¯

**åœºæ™¯ 1ï¼šæ¼æ¸²æŸ“**
```
æ¸²æŸ“: is_damaged() = false â†’ è·³è¿‡
PTY:  å†™å…¥æ–°æ•°æ®ï¼Œdamage = true
ç»“æœ: æ–°æ•°æ®å»¶è¿Ÿä¸€å¸§æ˜¾ç¤º
```

**åœºæ™¯ 2ï¼šstate è¿‡æ—¶**
```
æ¸²æŸ“: is_damaged() = true
PTY:  å†™å…¥æ–°æ•°æ®
æ¸²æŸ“: state() â†’ è·å–æ–°æ•°æ®ï¼ˆä¸æ˜¯æ£€æŸ¥æ—¶çš„çŠ¶æ€ï¼‰
ç»“æœ: é€»è¾‘ä¸ä¸€è‡´ï¼ˆæ£€æŸ¥çš„æ˜¯æ—§çŠ¶æ€ï¼Œæ¸²æŸ“çš„æ˜¯æ–°çŠ¶æ€ï¼‰
```

**åœºæ™¯ 3ï¼šé‡å¤æ¸²æŸ“**
```
æ¸²æŸ“: state() è·å–æ•°æ® A
æ¸²æŸ“: try_lock reset_damage å¤±è´¥
PTY:  å†™å…¥æ•°æ® Bï¼Œdamage = true
æ¸²æŸ“: ä¸‹ä¸€å¸§ is_damaged = trueï¼ˆA çš„ damage æ²¡ resetï¼‰
æ¸²æŸ“: state() è·å–æ•°æ® B
ç»“æœ: A çš„æ¸²æŸ“è¢«è¦†ç›–ï¼Œæµªè´¹ä¸€æ¬¡æ¸²æŸ“
```

**åœºæ™¯ 4ï¼šä¸¢å¤± damage**
```
æ¸²æŸ“: state() è·å–æ•°æ® A
PTY:  å†™å…¥æ•°æ® Bï¼Œdamage = true
æ¸²æŸ“: reset_damage() â†’ æŠŠ B çš„ damage ä¹Ÿ reset äº†ï¼
æ¸²æŸ“: ä¸‹ä¸€å¸§ is_damaged = false
ç»“æœ: æ•°æ® B ä¸¢å¤±ï¼
```

### æ ¹å› 

**æ£€æŸ¥ã€è·å–ã€é‡ç½®ä¸‰ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„**

ç†æƒ³æµç¨‹åº”è¯¥æ˜¯ï¼š
```rust
let guard = terminal.lock();
if guard.is_damaged() {
    let state = guard.state();
    guard.reset_damage();
    drop(guard);  // é‡Šæ”¾é”
    // æ¸²æŸ“ stateï¼ˆæ— é”ï¼‰
}
```

ä½†å½“å‰ç”¨ try_lock + å¤šæ¬¡è·å–ï¼Œå¯¼è‡´ç«æ€ã€‚

### è§£å†³æ–¹æ¡ˆ

1. **å•æ¬¡é”è·å–**ï¼šä¸€æ¬¡æ€§å®Œæˆ check + state + reset
2. **ç‰ˆæœ¬å·/åºåˆ—å·**ï¼šç”¨ç‰ˆæœ¬å·æ£€æµ‹å˜åŒ–ï¼Œè€Œé damage flag
3. **åŒç¼“å†²**ï¼šPTY å†™ç¼“å†² Aï¼Œæ¸²æŸ“è¯»ç¼“å†² Bï¼Œswap æ—¶åŸå­åˆ‡æ¢

## å…¶ä»–é—®é¢˜ï¼ˆCodex å‘ç°ï¼‰

### 1. HashMap UB é£é™© âš ï¸ ä¸¥é‡

`event_queue_callback` é€šè¿‡åŸå§‹æŒ‡é’ˆè®¿é—® HashMapï¼Œæ— åŒæ­¥æœºåˆ¶ï¼š

```rust
// src/app/terminal_pool.rs:963-968
unsafe {
    let pool = &*(context as *const TerminalPool);
    // PTY çº¿ç¨‹è¯»å– HashMapï¼Œæ— é”ï¼
    if let Some(entry) = pool.terminals.get(&terminal_id) {  // â† UB!
```

**é—®é¢˜**ï¼š
- PTY çº¿ç¨‹è°ƒç”¨ callback â†’ è¯» HashMap
- ä¸»çº¿ç¨‹å¯èƒ½åŒæ—¶ create/close terminal â†’ å†™ HashMap
- **= Data Race / Undefined Behavior**

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `RwLock<HashMap>` æˆ– `DashMap`
- æˆ–ç”¨ channel ä¼ é€’äº‹ä»¶ï¼Œé¿å…ç›´æ¥è®¿é—®

### 2. FontMetrics ç»•è¿‡ç¼“å­˜

`render_terminal` å¼€å¤´ç›´æ¥è°ƒç”¨ `FontMetrics::compute()`ï¼š

```rust
// src/app/terminal_pool.rs:579-585
let font_metrics = {
    let renderer = self.renderer.lock();
    crate::render::config::FontMetrics::compute(  // â† ç›´æ¥è®¡ç®—
        renderer.config(),
        &self.font_context,
    )
};
```

è€Œ `Renderer` å†…éƒ¨æœ‰ç¼“å­˜æœºåˆ¶ `get_font_metrics()`ï¼ˆå¸¦ `cached_metrics`ï¼‰ï¼Œä½†è¿™é‡Œæ²¡ç”¨ã€‚

**å½±å“**ï¼šæ¯å¸§é‡å¤è®¡ç®—ï¼ˆè™½ç„¶ä¸ç®—å¾ˆæ…¢ï¼‰

### 3. GPU Surface æ¯å¸§åˆ›å»º

```rust
// src/app/terminal_pool.rs:721-764
let mut temp_surface = self.create_temp_surface(...);  // æ¯å¸§åˆ›å»º
// ... æ¸²æŸ“ ...
let cached_image = temp_surface.image_snapshot();
// temp_surface åœ¨è¿™é‡Œè‡ªåŠ¨ dropï¼Œé‡Šæ”¾ GPU èµ„æº  â† æ¯å¸§é‡Šæ”¾ï¼
```

**é—®é¢˜**ï¼š
- æ¯å¸§ create + drop GPU Surface
- å¯ä»¥å¤ç”¨ï¼ˆå¦‚æœå°ºå¯¸ä¸å˜ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ TerminalEntry ä¸­ç¼“å­˜ Surface
- å°ºå¯¸å˜åŒ–æ—¶æ‰é‡å»º

## é—®é¢˜ä¼˜å…ˆçº§æ€»è§ˆ

| ä¼˜å…ˆçº§ | é—®é¢˜ | ä¸¥é‡æ€§ | å¤æ‚åº¦ |
|-------|------|-------|-------|
| P0 | HashMap UB | ğŸ”´ å®‰å…¨é—®é¢˜ | ä½ |
| P1 | state() O(N) éå† | ğŸ”´ 60ms/å¸§ | ä¸­ |
| P2 | TOCTOU ç«æ€ | ğŸŸ¡ å¯èƒ½ä¸¢æ•°æ® | ä¸­ |
| P3 | é”ç«äº‰ | ğŸŸ¡ 62ms é˜»å¡ | éš P1 è§£å†³ |
| P4 | GPU Surface å¤ç”¨ | ğŸŸ¢ æ€§èƒ½ä¼˜åŒ– | ä½ |
| P5 | FontMetrics ç¼“å­˜ | ğŸŸ¢ å°ä¼˜åŒ– | ä½ |

## å¾…è®¨è®º

- [x] æ¯é˜¶æ®µå®é™…è€—æ—¶ â†’ å·² benchmarkï¼Œè§ä¸Šæ–¹æ•°æ®
- [x] ç¼“å­˜ç­–ç•¥æ˜¯å¦åˆç† â†’ render_line ç¼“å­˜æœ‰æ•ˆï¼ˆ429x åŠ é€Ÿï¼‰ï¼Œé—®é¢˜åœ¨ state()
- [x] é”ç«äº‰åˆ†æ â†’ è§ä¸Šæ–¹
- [x] TOCTOU é—®é¢˜æ ¹å›  â†’ è§ä¸Šæ–¹
- [x] Codex ä»£ç å®¡æŸ¥ â†’ HashMap UBã€Surface å¤ç”¨ã€FontMetrics ç¼“å­˜
