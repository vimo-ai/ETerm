# ETerm 搜索历史缓冲区功能验证清单

## ✅ 代码实现检查

### Rust FFI 层
- [x] 实现 `RioTerminal::get_row_cells_absolute` 方法
- [x] 添加坐标转换逻辑（绝对行号 → Grid 行号）
- [x] 实现边界检查（防止越界访问）
- [x] 导出 FFI 函数 `rio_pool_get_row_cells_absolute`
- [x] Rust 代码编译通过（无错误）

### C 头文件
- [x] 在 `SugarloafBridge.h` 中添加函数声明
- [x] 参数类型正确（`int64_t absolute_row`）

### Swift 封装层
- [x] 在 `GlobalTerminalManager` 中添加 `getRowCellsAbsolute` 方法
- [x] 正确处理内存分配和释放
- [x] 使用 `UnsafeMutablePointer` 传递缓冲区

### 搜索引擎
- [x] 修改 `TerminalSearch.search` 方法
- [x] 使用绝对行号 API 替代旧的 API
- [x] 搜索范围从 0 到 `scrollback_lines + screen_lines`
- [x] 添加 `maxRows` 参数限制（默认 1000）
- [x] 更新 `searchAsync` 方法

## 🧪 功能测试

### 基础功能测试

#### 测试 1: 搜索历史缓冲区
```bash
# 1. 启动 ETerm
# 2. 在终端执行
seq 1 1000

# 3. 滚动到底部（让前面的数字进入历史缓冲区）
# 4. 按 Cmd+F 打开搜索
# 5. 搜索 "50"

# 预期结果：
# - 找到所有包含 "50" 的行（50, 150, 250, 350, ...）
# - 即使这些内容不在屏幕可见区域
```

#### 测试 2: 搜索可见区域
```bash
# 1. 在终端执行
echo "test visible area"

# 2. 按 Cmd+F 搜索 "visible"

# 预期结果：
# - 找到匹配项
# - 搜索可见区域功能仍然正常
```

#### 测试 3: 跳转到匹配项
```bash
# 1. 执行测试 1 生成大量历史
# 2. 搜索 "100"
# 3. 点击搜索结果或按 Enter 跳转

# 预期结果：
# - 自动滚动到包含 "100" 的行
# - 匹配项高亮显示
```

### 边界测试

#### 测试 4: 空搜索
```bash
# 1. 打开搜索框
# 2. 不输入任何内容

# 预期结果：
# - 不崩溃
# - 返回空结果
```

#### 测试 5: 超长搜索
```bash
# 1. 生成 5000 行历史
seq 1 5000

# 2. 搜索 "123"

# 预期结果：
# - 只搜索最近 1000 行（maxRows 限制）
# - 不会卡顿或崩溃
```

#### 测试 6: 特殊字符搜索
```bash
# 1. 执行包含特殊字符的命令
echo "test@example.com"
echo "path/to/file"

# 2. 搜索 "@", "/"

# 预期结果：
# - 正确找到匹配项
```

### 性能测试

#### 测试 7: 大量历史搜索性能
```bash
# 1. 生成 2000 行历史
seq 1 2000

# 2. 搜索常见字符（如 "1"）

# 预期结果：
# - 搜索在 1 秒内完成（异步执行）
# - UI 不冻结
```

## 📋 代码质量检查

### Rust 代码
- [x] 没有编译错误
- [x] 警告可接受（仅未使用变量等）
- [x] 坐标转换逻辑正确
- [x] 边界检查完善

### Swift 代码
- [x] 内存管理正确（无泄漏）
- [x] 异步处理得当
- [x] 错误处理完善

## 🔍 回归测试

### 验证现有功能未受影响

- [ ] 终端渲染正常
- [ ] 选区功能正常
- [ ] 滚动功能正常
- [ ] 复制粘贴功能正常
- [ ] 其他搜索相关功能（如高亮）正常

## 📝 文档检查

- [x] 创建实现文档（`SEARCH_SCROLLBACK_IMPLEMENTATION.md`）
- [x] 添加坐标系统说明
- [x] 添加测试方法
- [x] 添加后续优化建议

## 🚀 部署前检查

- [ ] 所有测试通过
- [ ] 代码 Review 完成
- [ ] 性能测试通过
- [ ] 文档更新完成
- [ ] 准备 Release Notes

## 已知限制

1. **搜索范围限制**: 默认最多搜索 1000 行，超出部分不会搜索
2. **搜索性能**: 大量匹配项时可能有轻微延迟
3. **正则表达式**: 当前不支持正则表达式搜索（后续优化）

## 后续优化计划

1. [ ] 增量搜索（只搜索新增的历史）
2. [ ] 搜索索引（倒排索引加速）
3. [ ] 正则表达式支持
4. [ ] 搜索结果缓存
5. [ ] 可配置的 maxRows 参数
