name: Release ETerm

on:
  push:
    tags:
      - 'eterm-v*'

permissions:
  contents: write

jobs:
  build-app:
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Parse tag info
        id: tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION=$(echo "$TAG" | sed 's/^eterm-v//')
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Build sugarloaf-ffi (terminal renderer)
        run: |
          cd rio
          cargo build --release -p sugarloaf-ffi --target aarch64-apple-darwin

          mkdir -p ../ETerm/ETerm/Libs/Sugarloaf
          cp target/aarch64-apple-darwin/release/libsugarloaf_ffi.a ../ETerm/ETerm/Libs/Sugarloaf/
          echo "Built libsugarloaf_ffi.a"

      - name: Build ETermKit.framework
        run: |
          cd Packages/ETermKit
          swift build -c release

          BUILD_DIR="$(pwd)/.build/release"
          FRAMEWORK_DIR="$(pwd)/../../Build/ETermKit.framework"
          ARCH=$(uname -m)

          # Create framework structure with Modules directory
          rm -rf "$FRAMEWORK_DIR"
          mkdir -p "$FRAMEWORK_DIR/Versions/A/Resources"
          mkdir -p "$FRAMEWORK_DIR/Versions/A/Modules/ETermKit.swiftmodule"

          # Copy dylib
          cp "$BUILD_DIR/libETermKit.dylib" "$FRAMEWORK_DIR/Versions/A/ETermKit"

          # Copy swiftmodule into framework's Modules directory
          # Provide both macosx and macos naming (different toolchains may use different triples)
          for triple in "${ARCH}-apple-macosx" "${ARCH}-apple-macos"; do
            cp "$BUILD_DIR/Modules/ETermKit.swiftmodule" "$FRAMEWORK_DIR/Versions/A/Modules/ETermKit.swiftmodule/${triple}.swiftmodule"
            cp "$BUILD_DIR/Modules/ETermKit.swiftdoc" "$FRAMEWORK_DIR/Versions/A/Modules/ETermKit.swiftmodule/${triple}.swiftdoc"
            cp "$BUILD_DIR/Modules/ETermKit.abi.json" "$FRAMEWORK_DIR/Versions/A/Modules/ETermKit.swiftmodule/${triple}.abi.json"
          done

          # Create Info.plist
          cat > "$FRAMEWORK_DIR/Versions/A/Resources/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleIdentifier</key>
              <string>com.vimo.ETermKit</string>
              <key>CFBundleName</key>
              <string>ETermKit</string>
              <key>CFBundlePackageType</key>
              <string>FMWK</string>
          </dict>
          </plist>
          EOF

          # Fix install name
          install_name_tool -id "@rpath/ETermKit.framework/ETermKit" "$FRAMEWORK_DIR/Versions/A/ETermKit"

          # Create symlinks (use subshell to avoid cd issues)
          (cd "$FRAMEWORK_DIR/Versions" && ln -sfh A Current)
          (cd "$FRAMEWORK_DIR" && ln -sfh Versions/Current/ETermKit ETermKit && ln -sfh Versions/Current/Resources Resources && ln -sfh Versions/Current/Modules Modules)

          # Sign
          codesign -f -s - "$FRAMEWORK_DIR"
          echo "ETermKit.framework built at $FRAMEWORK_DIR"

          # Debug: show created files
          echo "=== Build directory structure ==="
          ls -laR "$(pwd)/../../Build/"

      - name: Build builtin plugins
        run: |
          # Build all builtin plugins that ship with the app
          ./scripts/build-plugins.sh release build/plugins

      - name: Remove plugins with native dependencies
        run: |
          # Remove VlaudeKit and MemexKit - they have native dependencies
          # and are downloadable separately
          rm -rf Plugins/VlaudeKit
          rm -rf Plugins/MemexKit
          rm -rf Plugins/MCPRouterKit
          echo "Removed plugins with native dependencies"

      - name: Build ETerm.app
        run: |
          VERSION="${{ steps.tag.outputs.VERSION }}"

          xcodebuild -project ETerm/ETerm.xcodeproj \
                     -scheme ETerm \
                     -configuration Release \
                     -archivePath build/ETerm.xcarchive \
                     -destination 'generic/platform=macOS' \
                     MARKETING_VERSION="$VERSION" \
                     CODE_SIGN_IDENTITY="-" \
                     ARCHS=arm64 \
                     SWIFT_STRICT_CONCURRENCY=minimal \
                     archive

          # Export app
          cp -R build/ETerm.xcarchive/Products/Applications/ETerm.app build/

      - name: Embed built-in plugins
        run: |
          APP_PLUGINS="build/ETerm.app/Contents/PlugIns"
          mkdir -p "$APP_PLUGINS"

          # Copy all built plugins into the app bundle
          for bundle in build/plugins/*.bundle; do
            if [ -d "$bundle" ]; then
              cp -R "$bundle" "$APP_PLUGINS/"
              echo "Embedded: $(basename $bundle)"
            fi
          done

          echo "Embedded plugins:"
          ls -la "$APP_PLUGINS/"

      - name: Sign app
        run: |
          # Sign all embedded plugins
          find build/ETerm.app/Contents/PlugIns -name "*.bundle" -exec codesign -f -s - --deep {} \;

          # Sign frameworks
          find build/ETerm.app/Contents/Frameworks -name "*.framework" -exec codesign -f -s - {} \; 2>/dev/null || true
          find build/ETerm.app/Contents/Frameworks -name "*.dylib" -exec codesign -f -s - {} \; 2>/dev/null || true

          # Sign main app
          codesign -f -s - --deep build/ETerm.app

          # Verify
          codesign --verify --deep --strict build/ETerm.app
          echo "Signing completed"

      - name: Create DMG
        id: dmg
        run: |
          VERSION="${{ steps.tag.outputs.VERSION }}"
          DMG_NAME="ETerm-${VERSION}.dmg"

          # Create DMG
          hdiutil create -volname "ETerm" \
                         -srcfolder build/ETerm.app \
                         -ov -format UDZO \
                         "build/$DMG_NAME"

          # Calculate SHA256
          SHA256=$(shasum -a 256 "build/$DMG_NAME" | awk '{print $1}')
          SIZE=$(stat -f%z "build/$DMG_NAME")

          echo "DMG_NAME=$DMG_NAME" >> $GITHUB_OUTPUT
          echo "DMG_PATH=build/$DMG_NAME" >> $GITHUB_OUTPUT
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "SIZE=$SIZE" >> $GITHUB_OUTPUT

          echo "Created $DMG_NAME (SHA256: $SHA256, Size: $SIZE bytes)"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ETerm v${{ steps.tag.outputs.VERSION }}"
          files: ${{ steps.dmg.outputs.DMG_PATH }}
          body: |
            ## ETerm v${{ steps.tag.outputs.VERSION }}

            ### Download
            - **File**: `${{ steps.dmg.outputs.DMG_NAME }}`
            - **Size**: ${{ steps.dmg.outputs.SIZE }} bytes
            - **SHA256**: `${{ steps.dmg.outputs.SHA256 }}`

            ### Built-in Plugins
            - ClaudeKit
            - ClaudeMonitorKit
            - DevHelperKit
            - HistoryKit
            - OneLineCommandKit
            - TranslationKit
            - WorkspaceKit
            - WritingKit

            ### Optional Plugins (Download separately)
            - [VlaudeKit](https://github.com/vimo-ai/ETerm/releases?q=vlaudekit) - Claude remote control
            - [MemexKit](https://github.com/vimo-ai/ETerm/releases?q=memexkit) - Session history search
            - MCPRouterKit - MCP server management (requires mcp-router-core)

            ### Installation
            1. Open DMG and drag ETerm to Applications
            2. First launch: Right-click â†’ Open (or run `xattr -cr /Applications/ETerm.app`)
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.VERSION, 'beta') || contains(steps.tag.outputs.VERSION, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
